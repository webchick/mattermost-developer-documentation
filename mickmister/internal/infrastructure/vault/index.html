<!DOCTYPE html>





<html>
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title> Vault</title>
<meta name="viewport" content="width=device-width, initial-scale=1">   
<meta http-equiv="content-language" content="en-us" />



<link rel="canonical" href="../../../internal/infrastructure/vault/">


<link rel="shortcut icon" type="image/png" href="../../../img/favicon-32x32.png" />

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600" rel="stylesheet">


<link rel="stylesheet" href="../../../css/bootstrap.min.css">
<link rel="stylesheet" href="../../../css/tabs.css">
<link rel="stylesheet" href="../../../css/bar.css">
<link rel="stylesheet" href="../../../css/styles.css">
<link rel="stylesheet" href="../../../css/code.css">
<link rel="stylesheet" href="../../../css/note.css">


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="../../../js/tabs.js"></script>
<script src="../../../js/main.js"></script>
<script async defer src="https://buttons.github.io/buttons.js"></script>
<script async src="//cdn.bizible.com/scripts/bizible.js"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-64458817-2"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-64458817-2');
</script>


<script type="text/javascript">
    (function() {
    var didInit = false;
    function initMunchkin() {
    if(didInit === false) {
    didInit = true;
    Munchkin.init('161-FBE-733');
    }
    }
    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = '//munchkin.marketo.net/munchkin.js';
    s.onreadystatechange = function() {
    if (this.readyState == 'complete' || this.readyState == 'loaded') {
    initMunchkin();
    }
    };
    s.onload = initMunchkin;
    document.getElementsByTagName('head')[0].appendChild(s);
    })();
</script>


<script type="text/javascript" charset="utf-8">
    var _eiq = _eiq || [];
    var _engagio_settings = {
      accountId: "cb6a404b72e9141b70d1f82abc04db92b4e56238"
    };
    (function() {
      var ei = document.createElement('script'); ei.type = 'text/javascript'; ei.async = true;
      ei.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'web-analytics.engagio.com/js/ei.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ei, s);
    })();
  </script>

    </head>
<body>
    <header>
    <a href="../../../"><img src="../../../img/logo.svg" alt="Mattermost Logo" width="212px"></a>
    <div class="header__menu-toggle">
        <i class="fa fa-bars"></i>
    </div>
    <ul class="header__links--right">
        <li><a href="../../../">Home</a></li>
        
            
            
            
                
                    <li><a href="../../../contribute/getting-started">Contribute</a></li>
                
            
        
            
            
            
                
                    <li><a href="../../../integrate/getting-started">Integrate</a></li>
                
            
        
            
            
            
                
                    <li><a href="../../../extend/getting-started">Extend</a></li>
                
            
        
            
            
            
                
                    <li><a href="../../../blog">Blog</a></li>
                
            
        
            
            
            
                
                    <li><a href="https://docs.mattermost.com/">Admin Docs</a></li>
                
            
        
    </ul>
</header>




    <div id="wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-3 sidebar">
    <div class="sidebar__menu-toggle">
        Vault
        <i class="fa fa-bars pull-right"></i>
    </div>
    <div class="row sidebar__links">
        
            
                
                

                
                

                
                    
                

                <span class="item ">
                    <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style=""></i>
                    
                        <a href="../../../internal/infrastructure/"> Infrastructure</a>
                    
                </span>
                <ul class="sub-menu" >
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style=""></i>
                            
                                <a href="../../../internal/infrastructure/kubernetes/"> Kubernetes</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                                <a class="item " href="../../../internal/infrastructure/kubernetes/kubernetes-troubleshooting/">Kubernetes Maintenance</a>
                            
                        </ul>
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a href="../../../internal/infrastructure/grafana/"> Community Grafana</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                        </ul>
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a href="../../../internal/infrastructure/vpn-cloud/"> VPN(CLOUD)</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                        </ul>
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a href="../../../internal/infrastructure/vpn/"> VPN</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                        </ul>
                    
                        
                        

                        
                        
                            
                        

                        
                            
                        

                        <span class="item active">
                            <i class="sub-menu__toggle fa fa-minus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a class="active" href="../../../internal/infrastructure/vault/"> Vault</a></span>
                            
                        </span>
                        <ul class="sub-menu" style="display: block">
                            
                        </ul>
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a href="../../../internal/infrastructure/plugins/"> Adding a Plugin to Community</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                        </ul>
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a href="../../../internal/infrastructure/aws/"> AWS</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                        </ul>
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a href="../../../internal/infrastructure/onelogin-aws/"> OneLogin and AWS</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                        </ul>
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a href="../../../internal/infrastructure/build/"> Build</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                        </ul>
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a href="../../../internal/infrastructure/guidelines/"> Guidelines for New Infrastructure</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                        </ul>
                    
                </ul>
            
                
                

                
                

                
                    
                

                <span class="item ">
                    <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                    
                        <a href="../../../internal/qa/"> QA</a>
                    
                </span>
                <ul class="sub-menu" >
                    
                </ul>
            
                
                

                
                

                
                    
                

                <span class="item ">
                    <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                    
                        <a href="../../../internal/offboarding/"> Offboarding</a>
                    
                </span>
                <ul class="sub-menu" >
                    
                </ul>
            
                
                

                
                

                
                    
                

                <span class="item ">
                    <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style=""></i>
                    
                        <a href="../../../internal/onboarding/"> Onboarding</a>
                    
                </span>
                <ul class="sub-menu" >
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a href="../../../internal/onboarding/new-staff-guide/"> New Staff Guide</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                        </ul>
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a href="../../../internal/onboarding/manager-guide/"> Manager Guide</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                        </ul>
                    
                </ul>
            
                
                

                
                

                
                    
                

                <span class="item ">
                    <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style=""></i>
                    
                        <a href="../../../internal/mobile-build-process/"> Mobile Build Process</a>
                    
                </span>
                <ul class="sub-menu" >
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a href="../../../internal/mobile-build-process/bump-version-number/"> Bump Version Number</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                        </ul>
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a href="../../../internal/mobile-build-process/bump-build-number/"> Bump Build Number</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                        </ul>
                    
                        
                        

                        
                        

                        
                            
                        

                        <span class="item ">
                            <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                            
                                <a href="../../../internal/mobile-build-process/troubleshooting/"> Troubleshooting</a></span>
                            
                        </span>
                        <ul class="sub-menu" >
                            
                        </ul>
                    
                </ul>
            
                
                

                
                

                
                    
                

                <span class="item ">
                    <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                    
                        <a href="../../../internal/release-tagging-process/"> Release Tagging Process</a>
                    
                </span>
                <ul class="sub-menu" >
                    
                </ul>
            
                
                

                
                

                
                    
                

                <span class="item ">
                    <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                    
                        <a href="../../../internal/release-process/"> Release Cutting Process</a>
                    
                </span>
                <ul class="sub-menu" >
                    
                </ul>
            
                
                

                
                

                
                    
                

                <span class="item ">
                    <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                    
                        <a href="../../../internal/plugin-release-process/"> Plugin Release Process</a>
                    
                </span>
                <ul class="sub-menu" >
                    
                </ul>
            
                
                

                
                

                
                    
                

                <span class="item ">
                    <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                    
                        <a href="../../../internal/tips-and-best-practices/"> Tips and Best Practices</a>
                    
                </span>
                <ul class="sub-menu" >
                    
                </ul>
            
                
                

                
                

                
                    
                

                <span class="item ">
                    <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                    
                        <a href="../../../internal/writing-a-blog-post/"> Writing a Blog Post</a>
                    
                </span>
                <ul class="sub-menu" >
                    
                </ul>
            
                
                

                
                

                
                    
                

                <span class="item ">
                    <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                    
                        <a href="../../../internal/rd-teams/"> R&amp;D Teams</a>
                    
                </span>
                <ul class="sub-menu" >
                    
                </ul>
            
                
                

                
                

                
                    
                

                <span class="item ">
                    <i class="sub-menu__toggle fa fa-plus-square-o" aria-hidden="true" style="display: none"></i>
                    
                        <a href="../../../internal/sustained-engineering/"> Sustained Engineering Team</a>
                    
                </span>
                <ul class="sub-menu" >
                    
                </ul>
            
        
    </div>
</div>

                <div class="col-lg-9 doc-content">
                    
<a href="https://github.com/mattermost/mattermost-developer-documentation/edit/master/site/content/internal/infrastructure/vault.md" class="float-right edit-github">
    Edit on GitHub
</a>


                    <h1 class="mt-0 doc-title">
                        Vault
                    </h1>
                    <p>Vault is a high security secret store. At Mattermost, its primary purpose is to sign SSH keys.</p>
<h2 id="installation">Installation&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#installation"></i></a> </h2>
<p>If you&rsquo;re on macOS and have Brew installed, you can just <code>brew install vault</code>. Otherwise, see the <a href="https://www.vaultproject.io/docs/install/index.html">Vault installation instructions</a>.</p>
<p>Once installed, you&rsquo;ll need to configure it. Add the following to your .bash_profile or .zshrc:</p>
<pre><code>export VAULT_ADDR='https://vault.internal.mattermost.com:8200'
</code></pre><h2 id="authenticating">Authenticating&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#authenticating"></i></a> </h2>
<p>Authentication is done via OneLogin and RADIUS:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">$ vault login -method<span style="color:#555">=</span>radius <span style="color:#033">username</span><span style="color:#555">=</span>your_username@mattermost.com
</code></pre></div><p>OneLogin users must have the &ldquo;Developers&rdquo; role in order to authenticate.</p>
<p>Note: If authentication times out or fails for any reason other than &ldquo;access denied by the authentication server&rdquo;, have a OneLogin admin verify that the Vault server IP addresses are whitelisted in the OneLogin RADIUS configuration.</p>
<h2 id="sshing-into-a-machine">SSH&rsquo;ing into a Machine&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#sshing-into-a-machine"></i></a> </h2>
<p>You can use a command like the following to sign your SSH key and connect to a machine:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">$ vault ssh -mount-point<span style="color:#555">=</span>dev-ssh-signer -mode<span style="color:#555">=</span>ca -role<span style="color:#555">=</span>default -private-key-path<span style="color:#555">=</span>~/.ssh/id_ed25519 -public-key-path<span style="color:#555">=</span>~/.ssh/id_ed25519.pub ubuntu@52.87.227.129
</code></pre></div><p>Creating a wrapper or alias for this command is recommended.</p>
<p>Generate an <code>ed25519</code> SSH key with:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Bash" data-lang="Bash">$ ssh-keygen -o -a <span style="color:#f60">100</span> -t ed25519 -f ~/.ssh/id_ed25519 -C <span style="color:#c30">&#34;your_username@mattermost.com&#34;</span>
</code></pre></div><h2 id="configuring-ssh-on-a-host-machine">Configuring SSH on a Host Machine&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#configuring-ssh-on-a-host-machine"></i></a> </h2>
<p>To configure SSH on a host machine, you need to copy Vault&rsquo;s CA certificate to that machine and point the &ldquo;TrustedUserCAKeys&rdquo; option to it in /etc/ssh/sshd_config.</p>
<p>The certificate can be obtained via&hellip;</p>
<pre><code>vault read dev-ssh-signer/config/ca
</code></pre><p>When launching a machine on EC2 that you want to make accessible to all developers, you can simply use this as &ldquo;user data&rdquo; when launching the machine:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#09f;font-style:italic">#cloud-config</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#069;font-weight:bold">bootcmd</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- cloud-init-per<span style="color:#bbb"> </span>once<span style="color:#bbb"> </span>ssh-users-ca<span style="color:#bbb"> </span>echo<span style="color:#bbb"> </span><span style="color:#c30">&#34;TrustedUserCAKeys /etc/ssh/trusted_ca_keys.pub&#34;</span><span style="color:#bbb"> </span>&gt;&gt;<span style="color:#bbb"> </span>/etc/ssh/sshd_config<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#069;font-weight:bold">write_files</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#069;font-weight:bold">path</span>:<span style="color:#bbb"> </span>/etc/ssh/trusted_ca_keys.pub<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">content</span>:<span style="color:#bbb"> </span>ssh-rsa<span style="color:#bbb"> </span>AAAAB3NzaC1yc2EAAAADAQABAAACAQDHDwQhQ3eRiW4CV5RKAJb0n9P/07aHrku5hAVc+M59ejZHPVD/4sEfSaKvIXNTcY5TsrudzEhY3nVBsJDcJjb5qC5ayy+JNGFNnF05JoZ4E3tggJm5HQv3Znm/N6s65ZMA0HsZojCvEf+K8P0AKdJWiZbZGF095+N3WL9bUQIxBmCIBVPAOQSTCo8QKeorFfxhw/XcmH3s/KDV52/hEt6RWTxaDup03r7y8fbVo81F4QJ2ItmHgL3vGSpJk/nkLB2RWxT6zp4JIEo7PZ6S2Gm/2jaW+B5DftUd0gI8GKo9+vhtWjEEbOdu/mz92/GHLHW+s3TnftLeXVs7a8UYwdh/qJ4P64U3wlA//igo7ToXONsZ4TwmcKg6FD9JAq+LKTC0+prx/Gulx5esiPS+bgnkM/CMuoWMtucLoXaNz9ELBmeb6QSj1a7T/4LFzBiefT977OIhglORnEsKvY0HXvzX66a73Lm3bC9mUXxi1HSJNTDdLOmnVK+ipVjViy2/C9KJmKL3ePwBQSJ9d9IK76W4SGXTGT4mTVBSSF6j+/2a4tXq9c3NCuEWyXgPJRP1t6Iib42oAosxPoZ4zeBZM05BHbveD2b0G/bmeaZRgsEaZ3Qjnr50a6Wke7Vr9q3QGjn3+8QEdUdrnCTN8dlloLYhwY9pgh1JEYDaCdPHSP1ppw==<span style="color:#bbb">
</span></code></pre></div><h2 id="unsealing-the-vault">Unsealing the Vault&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#unsealing-the-vault"></i></a> </h2>
<p>When the Vault instance starts up, it needs to be &ldquo;unsealed&rdquo; in order to decrypt its storage and become functional. At the time of writing, there are 8 keyholders. Two of them must work together to unseal Vault using this command:</p>
<pre><code>VAULT_ADDR='https://vault-sealed.mattermost.com' vault unseal
</code></pre>

                </div>
            </div>
        </div>
    </div>
    <footer class="text-center">
    <div class="container-fluid">
        <div class="footer__copyright">© Mattermost, Inc. All Rights Reserved.</div>
        <div class="footer__icons">
            <a href="https://www.facebook.com/Mattermost-2300985916642531/"><i class="fa fa-facebook"></i></a>
            <a href="https://twitter.com/mattermost"><i class="fa fa-twitter"></i></a>
            <a href="https://www.youtube.com/channel/UCNR05H72hi692y01bWaFXNA"><i class="fa fa-youtube"></i></a>
        </div>
    </div>
</footer>

</body>
</html>
