<!DOCTYPE html>





<html>

<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title> Subpath Support</title>
<meta name="viewport" content="width=device-width, initial-scale=1">   
<meta http-equiv="content-language" content="en-us" />



<link rel="canonical" href="../../blog/subpath/">


<link rel="shortcut icon" type="image/png" href="../../img/favicon-32x32.png" />

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600" rel="stylesheet">


<link rel="stylesheet" href="../../css/bootstrap.min.css">
<link rel="stylesheet" href="../../css/tabs.css">
<link rel="stylesheet" href="../../css/bar.css">
<link rel="stylesheet" href="../../css/styles.css">
<link rel="stylesheet" href="../../css/code.css">
<link rel="stylesheet" href="../../css/note.css">


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="../../js/tabs.js"></script>
<script src="../../js/main.js"></script>
<script async defer src="https://buttons.github.io/buttons.js"></script>
<script async src="//cdn.bizible.com/scripts/bizible.js"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-64458817-2"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-64458817-2');
</script>


<script type="text/javascript">
    (function() {
    var didInit = false;
    function initMunchkin() {
    if(didInit === false) {
    didInit = true;
    Munchkin.init('161-FBE-733');
    }
    }
    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = '//munchkin.marketo.net/munchkin.js';
    s.onreadystatechange = function() {
    if (this.readyState == 'complete' || this.readyState == 'loaded') {
    initMunchkin();
    }
    };
    s.onload = initMunchkin;
    document.getElementsByTagName('head')[0].appendChild(s);
    })();
</script>


<script type="text/javascript" charset="utf-8">
    var _eiq = _eiq || [];
    var _engagio_settings = {
      accountId: "cb6a404b72e9141b70d1f82abc04db92b4e56238"
    };
    (function() {
      var ei = document.createElement('script'); ei.type = 'text/javascript'; ei.async = true;
      ei.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'web-analytics.engagio.com/js/ei.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ei, s);
    })();
  </script>

</head>

<body class="blog-single">
    <header>
    <a href="../../"><img src="../../img/logo.svg" alt="Mattermost Logo" width="212px"></a>
    <div class="header__menu-toggle">
        <i class="fa fa-bars"></i>
    </div>
    <ul class="header__links--right">
        <li><a href="../../">Home</a></li>
        
            
            
            
                
                    <li><a href="../../contribute/getting-started">Contribute</a></li>
                
            
        
            
            
            
                
                    <li><a href="../../integrate/getting-started">Integrate</a></li>
                
            
        
            
            
            
                
                    <li><a href="../../extend/getting-started">Extend</a></li>
                
            
        
            
            
            
                
                    <li class="active"><a href="../../blog">Blog</a></li>
                
            
        
            
            
            
                
                    <li><a href="https://docs.mattermost.com/">Admin Docs</a></li>
                
            
        
    </ul>
</header>




    <div class="container">
        <div class="row">
            <div class="col-md-9 doc-content">
                <div class="well well-sm">
                    <div class="blog-item__header">
                        <div class="blog-item__title">Subpath Support<br> <small></small></div>
                        <div class="blog-item__info">
                            June 25, 2018
                            <small class="blog-item__count">393 words</small>
                        </div>
                    </div>
                    <hr>
                    <p>Mattermost 5.1 will include support for <a href="https://mattermost.atlassian.net/browse/MM-10366">serving Mattermost from subpaths</a>. This allows Mattermost to be exposed at something like <a href="https://example.com/company/mattermost,">https://example.com/company/mattermost,</a> with your proxy server exposing different services at other subpaths. Subpath support is configured via the <a href="https://docs.mattermost.com/administration/config-settings.html?highlight=siteurl#site-url">Site URL</a>.</p>
<h4 id="using-subpaths-in-production">Using subpaths in production&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#using-subpaths-in-production"></i></a> </h4>
<p>In production, after configuration and restart, the application server expects all HTTP requests to be anchored to the configured subpath. This includes static assets, API calls, and WebSockets. For convenience, the application server redirects any unexpected requests back into this subpath, e.g. forwarding <a href="http://example.com/login">http://example.com/login</a> to <a href="http://example.com/company/mattermost/login">http://example.com/company/mattermost/login</a>.</p>
<p>The pre-built static assets shipped with Mattermost assume being hosted at <code>/static/</code>. In production, when the <code>SiteURL</code> is configured with a subpath such as <a href="https://example.com/company/mattermost,">https://example.com/company/mattermost,</a> the application server rewrites any affected assets on startup to point at <code>/company/mattermost/static</code> instead. This rewriting can be done manually with the <code>mattermost config subpath</code> command:</p>
<pre><code>mattermost config subpath --path /company/mattermost
</code></pre><p>Rewriting the static assets manually may be necessary when deploying to a CDN.</p>
<h4 id="using-subpaths-in-development">Using subpaths in development&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#using-subpaths-in-development"></i></a> </h4>
<p>In development, with webpack running, the static assets are rewritten whenever a source file changes. While the server is still configured via the <code>SiteURL</code>, webpack requires this to be set via an environment variable:</p>
<pre><code>cd mattermost-webapp/
make stop
export MM_SERVICESETTINGS_SITEURL='http://localhost:8065/company/mattermost'
make run
</code></pre><p>To resume testing at the root, either define a <code>SiteURL</code> with no subpath or unset the environment variable:</p>
<pre><code>unset MM_SERVICESETTINGS_SITEURL
make restart
</code></pre><p>This environment variable is also honoured by the server as an override to config.json as described in <a href="https://docs.mattermost.com/administration/config-settings.html#configuration-settings">documentation</a>. Therefore, you can include this export in your shell&rsquo;s initialization script to apply to both the server and the webapp simultaneously.</p>
<h4 id="how-do-subpaths-work">How do subpaths work?&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#how-do-subpaths-work"></i></a> </h4>
<p>Under the covers, in development, our <a href="https://github.com/mattermost/mattermost-webapp/blob/daefd1c76844612f3aaccfb5e42f12000e59cbfd/webpack.config.js#L136">webpack.config.js</a> parses the <code>MM_SERVICESETTINGS_SITEURL</code> environment variable to extract the subpath. This is first used by <a href="https://webpack.js.org/plugins/html-webpack-plugin/">HtmlWebpackPlugin</a> to anchor the assets loaded by <a href="https://github.com/mattermost/mattermost-webapp/blob/master/root.html">root.html</a>. It is then exported into the node environment as <code>process.env.PUBLIC_PATH</code> and used by <a href="https://github.com/mattermost/mattermost-webapp/blob/master/entry.js">entry.js</a> to define <a href="https://webpack.js.org/guides/public-path/"><code>__webpack_public_path__</code></a>, affecting all modules loaded dynamically after the web application starts.</p>
<p>In production, with a non-root subpath, the application server <a href="https://github.com/mattermost/mattermost-server/blob/dd35ad43caab407cc70ef3b153b3f94d57242ed9/utils/subpath.go#L26">rewrites</a> root.html to export <code>window.publicPath</code>. This is checked by entry.js to similarly define <code>__webpack_public_path__</code>. Since <code>HtmlWebpackPlugin</code> is only run during development, the server also rewrites parts of <code>root.html</code> and various CSS files to reflect the correct subpath. To make the rewriting robust against multiple subpath changes, the application server <a href="https://github.com/mattermost/mattermost-server/blob/dd35ad43caab407cc70ef3b153b3f94d57242ed9/utils/subpath.go#L50">uses</a> any existing definition of <code>window.publicPath</code> to match the appropriate strings.</p>


                    <hr>
                    
                    Written by
                    
                    Jesse Hallam
-
<a href="https://community.mattermost.com/core/messages/@jesse.hallam" target="_blank">
    @jesse.hallam
</a>
on
<a href="https://community.mattermost.com/signup_user_complete/?id=f1924a8db44ff3bb41c96424cdc20676" target="_blank">
    community.mattermost.com
</a>
and
<a href="https://github.com/lieut-data" target="_blank">
    @lieut-data
</a>
on GitHub

                    
                    
                    <br />
                    <br />
                    Join us on <a href="https://community.mattermost.com/signup_user_complete/?id=f1924a8db44ff3bb41c96424cdc20676"
                        target="_blank">community.mattermost.com</a>!
                </div>
            </div>

            
            <div class="col-md-3 doc-content tags-sidebar">
                <div class="well well-sm">
                    
                    


                    <h6>Other Posts</h6>
                    <ul class="list-unstyled">
                        
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/pritunl/">From OpenVPN to Pritunl VPN: The transition</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/open-tracing/">OpenTracing for Go Projects</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/hands-on-iouring-go/">Getting Hands-on with io_uring using Go</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/advanced-git-tbilisi-free-university/">Advanced Git with the Free University of Tbilisi</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/all-about-emojis/">All About Emojis</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/maintaining-consistency-in-codebases-with-go-vet/">Maintaining Consistency in Codebases with Go vet</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/instrumenting-go-code-via-ast-2/">Instrumenting Go code via AST, Part 2</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/layered-store-and-struct-embedding/">Layered Store and Struct Embedding in Go</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/incorporating-golangci-lint/">Incorporating GolangCI-Lint at Mattermost</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/on-hermes-and-mattermost/">On Hermes and Mattermost</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/onboarding-with-mattermost/">Onboarding with Mattermost</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/kubecon-na-2019/">KubeCon NA 2019</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/cloud-monitoring/">Monitoring a Multi-Cluster Environment Using Prometheus Federation and Grafana</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/localizing-matterpoll/">Localizing Matterpoll</a></li>
                        
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>

</html>