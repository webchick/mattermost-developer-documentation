<!DOCTYPE html>





<html>

<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title> Layered Store and Struct Embedding in Go</title>
<meta name="viewport" content="width=device-width, initial-scale=1">   
<meta http-equiv="content-language" content="en-us" />



<link rel="canonical" href="../../blog/layered-store-and-struct-embedding/">


<link rel="shortcut icon" type="image/png" href="../../img/favicon-32x32.png" />

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600" rel="stylesheet">


<link rel="stylesheet" href="../../css/bootstrap.min.css">
<link rel="stylesheet" href="../../css/tabs.css">
<link rel="stylesheet" href="../../css/bar.css">
<link rel="stylesheet" href="../../css/styles.css">
<link rel="stylesheet" href="../../css/code.css">
<link rel="stylesheet" href="../../css/note.css">


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="../../js/tabs.js"></script>
<script src="../../js/main.js"></script>
<script async defer src="https://buttons.github.io/buttons.js"></script>
<script async src="//cdn.bizible.com/scripts/bizible.js"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-64458817-2"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-64458817-2');
</script>


<script type="text/javascript">
    (function() {
    var didInit = false;
    function initMunchkin() {
    if(didInit === false) {
    didInit = true;
    Munchkin.init('161-FBE-733');
    }
    }
    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = '//munchkin.marketo.net/munchkin.js';
    s.onreadystatechange = function() {
    if (this.readyState == 'complete' || this.readyState == 'loaded') {
    initMunchkin();
    }
    };
    s.onload = initMunchkin;
    document.getElementsByTagName('head')[0].appendChild(s);
    })();
</script>


<script type="text/javascript" charset="utf-8">
    var _eiq = _eiq || [];
    var _engagio_settings = {
      accountId: "cb6a404b72e9141b70d1f82abc04db92b4e56238"
    };
    (function() {
      var ei = document.createElement('script'); ei.type = 'text/javascript'; ei.async = true;
      ei.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'web-analytics.engagio.com/js/ei.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ei, s);
    })();
  </script>

</head>

<body class="blog-single">
    <header>
    <a href="../../"><img src="../../img/logo.svg" alt="Mattermost Logo" width="212px"></a>
    <div class="header__menu-toggle">
        <i class="fa fa-bars"></i>
    </div>
    <ul class="header__links--right">
        <li><a href="../../">Home</a></li>
        
            
            
            
                
                    <li><a href="../../contribute/getting-started">Contribute</a></li>
                
            
        
            
            
            
                
                    <li><a href="../../integrate/getting-started">Integrate</a></li>
                
            
        
            
            
            
                
                    <li><a href="../../extend/getting-started">Extend</a></li>
                
            
        
            
            
            
                
                    <li class="active"><a href="../../blog">Blog</a></li>
                
            
        
            
            
            
                
                    <li><a href="https://docs.mattermost.com/">Admin Docs</a></li>
                
            
        
    </ul>
</header>




    <div class="container">
        <div class="row">
            <div class="col-md-9 doc-content">
                <div class="well well-sm">
                    <div class="blog-item__header">
                        <div class="blog-item__title">Layered Store and Struct Embedding in Go<br> <small></small></div>
                        <div class="blog-item__info">
                            February 26, 2020
                            <small class="blog-item__count">1579 words</small>
                        </div>
                    </div>
                    <hr>
                    <p>One of the most important parts of the Mattermost source code is the one
responsible for accessing the Mattermost database - the store. Every
single database access is handled by the store, so we needed to find a way to
extend its functionality while introducing as little complexity as possible.
This is the reason behind the current layered approach using struct embedding.</p>
<p>Our store is responsible for storing and retrieving data, and sometimes we
need to add functionality that is not strictly related to the database queries,
for example, cache data or add instrumentation. Those are transversal tasks
and don&rsquo;t necessarily need to be in the same block of code.</p>
<p>Our approach is based in idea of a core store, the one accessing the source
of truth (the database), and a set of layers on top of that adding extra
behavior. All of them, the core store and all the layers must implement
the same interface, in this case the store interface. This way, from the
outside, there is no difference between our core store without layers, or our
core store with 1000 layers on top of it.</p>
<p><img src="../../blog/2020-02-26-layered-store-and-struct-embedding/layers.png" alt="layers"></p>
<p>Each layer is going to embed another layer until the last layer embeds the core
store. Each layer is going to override some methods (or all, depending on the
layer). Each layer is responsible for deciding what is handled entirely by the
layer (for example a cache hit) or is delegated to the underneath layer (for
example a cache miss).</p>
<p>In our case, the core store is the SqlStore which encapsulates all the SQL
queries execution. And the layers that we put on top of that are:</p>
<ul>
<li>The Cache Layer: Responsible for maintaining a cache of the store calls.</li>
<li>The Search Layer: Responsible for speeding up the search methods using
search engines.</li>
<li>The Timer Layer: Responsible for sending the duration of each request to a
histogram in Prometheus.</li>
<li>The OpenTracing Layer: Responsible for adding the open tracing information
related to the store to the open tracing context.</li>
</ul>
<p>These four layers add functionality to our store without touching a
single line of code of the SqlStore implementation.</p>
<p>How do we do that?</p>
<p>To solve this problem, we used structure embedding which is a tool provided by Go to extend
the behavior of a struct based on another struct. I prefer to not
use the term inheritance here because it is not correct; it is embedding, not
inheritance. If you want to dive deeper into this concept, take a look at
the video of the talk <a href="https://www.youtube.com/watch?v=-LzYjMzfGDQ">Embedding in go</a>
from <a href="https://twitter.com/StabbyCutyou">Sean Kelly</a>, he explains it better than
I can.</p>
<p>As an example I&rsquo;m going to create a small, simplified version of what we have,
but storing the data in memory (with a small simulated delay) instead of a
database (for simplification).</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#069;font-weight:bold">package</span> main

<span style="color:#069;font-weight:bold">import</span> (
	<span style="color:#c30">&#34;fmt&#34;</span>
	<span style="color:#c30">&#34;time&#34;</span>

	<span style="color:#c30">&#34;github.com/pkg/errors&#34;</span>
)

<span style="color:#069;font-weight:bold">type</span> User <span style="color:#069;font-weight:bold">struct</span> {
	Username <span style="color:#078;font-weight:bold">string</span>
	FullName <span style="color:#078;font-weight:bold">string</span>
}

<span style="color:#069;font-weight:bold">type</span> Store <span style="color:#069;font-weight:bold">interface</span> {
	<span style="color:#c0f">GetUser</span>(username <span style="color:#078;font-weight:bold">string</span>) (<span style="color:#555">*</span>User, <span style="color:#078;font-weight:bold">error</span>)
	<span style="color:#c0f">CountUsers</span>() <span style="color:#078;font-weight:bold">int</span>
	<span style="color:#c0f">DeleteUser</span>(username <span style="color:#078;font-weight:bold">string</span>) <span style="color:#078;font-weight:bold">error</span>
}

<span style="color:#069;font-weight:bold">type</span> MapStore <span style="color:#069;font-weight:bold">struct</span> {
	db <span style="color:#069;font-weight:bold">map</span>[<span style="color:#078;font-weight:bold">string</span>]<span style="color:#555">*</span>User
}

<span style="color:#069;font-weight:bold">func</span> <span style="color:#c0f">NewMapStore</span>() <span style="color:#555">*</span>MapStore {
	<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">&amp;</span>MapStore{db: <span style="color:#366">make</span>(<span style="color:#069;font-weight:bold">map</span>[<span style="color:#078;font-weight:bold">string</span>]<span style="color:#555">*</span>User)}
}

<span style="color:#069;font-weight:bold">func</span> (s <span style="color:#555">*</span>MapStore) <span style="color:#c0f">GetUser</span>(username <span style="color:#078;font-weight:bold">string</span>) (<span style="color:#555">*</span>User, <span style="color:#078;font-weight:bold">error</span>) {
	time.<span style="color:#c0f">Sleep</span>(<span style="color:#f60">100</span> <span style="color:#555">*</span> time.Millisecond)
	user, ok <span style="color:#555">:=</span> s.db[username]
	<span style="color:#069;font-weight:bold">if</span> !ok {
		<span style="color:#069;font-weight:bold">return</span> <span style="color:#069;font-weight:bold">nil</span>, errors.<span style="color:#c0f">New</span>(<span style="color:#c30">&#34;User not found&#34;</span>)
	}
	<span style="color:#069;font-weight:bold">return</span> user, <span style="color:#069;font-weight:bold">nil</span>
}

<span style="color:#069;font-weight:bold">func</span> (s <span style="color:#555">*</span>MapStore) <span style="color:#c0f">CountUsers</span>() <span style="color:#078;font-weight:bold">int</span> {
	time.<span style="color:#c0f">Sleep</span>(<span style="color:#f60">150</span> <span style="color:#555">*</span> time.Millisecond)
	<span style="color:#069;font-weight:bold">return</span> <span style="color:#366">len</span>(s.db)
}

<span style="color:#069;font-weight:bold">func</span> (s <span style="color:#555">*</span>MapStore) <span style="color:#c0f">DeleteUser</span>(username <span style="color:#078;font-weight:bold">string</span>) <span style="color:#078;font-weight:bold">error</span> {
	time.<span style="color:#c0f">Sleep</span>(<span style="color:#f60">200</span> <span style="color:#555">*</span> time.Millisecond)
	<span style="color:#069;font-weight:bold">if</span> _, ok <span style="color:#555">:=</span> s.db[username]; !ok {
		<span style="color:#069;font-weight:bold">return</span> errors.<span style="color:#c0f">New</span>(<span style="color:#c30">&#34;User not found&#34;</span>)
	}
	<span style="color:#366">delete</span>(s.db, username)
	<span style="color:#069;font-weight:bold">return</span> <span style="color:#069;font-weight:bold">nil</span>
}
<span style="color:#555">...</span>
</code></pre></div><p>This would be an example base store, now on top of that I&rsquo;m going to create an example Cache Layer:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#555">...</span>
<span style="color:#069;font-weight:bold">type</span> CacheLayer <span style="color:#069;font-weight:bold">struct</span> {
	Store
	cache <span style="color:#069;font-weight:bold">map</span>[<span style="color:#078;font-weight:bold">string</span>]<span style="color:#555">*</span>User
}

<span style="color:#069;font-weight:bold">func</span> <span style="color:#c0f">NewCacheLayer</span>(substore Store) <span style="color:#555">*</span>CacheLayer {
	<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">&amp;</span>CacheLayer{
		Store: substore,
		cache: <span style="color:#366">make</span>(<span style="color:#069;font-weight:bold">map</span>[<span style="color:#078;font-weight:bold">string</span>]<span style="color:#555">*</span>User),
	}
}

<span style="color:#069;font-weight:bold">func</span> (s <span style="color:#555">*</span>CacheLayer) <span style="color:#c0f">GetUser</span>(username <span style="color:#078;font-weight:bold">string</span>) (<span style="color:#555">*</span>User, <span style="color:#078;font-weight:bold">error</span>) {
	user, ok <span style="color:#555">:=</span> s.cache[username]
	<span style="color:#069;font-weight:bold">if</span> ok {
		<span style="color:#069;font-weight:bold">return</span> user, <span style="color:#069;font-weight:bold">nil</span>
	}
	user, err <span style="color:#555">:=</span> s.Store.<span style="color:#c0f">GetUser</span>(username)
	<span style="color:#069;font-weight:bold">if</span> err <span style="color:#555">!=</span> <span style="color:#069;font-weight:bold">nil</span> {
		<span style="color:#069;font-weight:bold">return</span> <span style="color:#069;font-weight:bold">nil</span>, err
	}
	s.cache[username] = user
	<span style="color:#069;font-weight:bold">return</span> user, <span style="color:#069;font-weight:bold">nil</span>
}

<span style="color:#069;font-weight:bold">func</span> (s <span style="color:#555">*</span>CacheLayer) <span style="color:#c0f">DeleteUser</span>(username <span style="color:#078;font-weight:bold">string</span>) <span style="color:#078;font-weight:bold">error</span> {
	<span style="color:#366">delete</span>(s.cache, username)
	<span style="color:#069;font-weight:bold">return</span> s.Store.<span style="color:#c0f">DeleteUser</span>(username)
}
<span style="color:#555">...</span>
</code></pre></div><p>Here we are creating a new struct called <code>CacheLayer</code>, this struct embeds the
<code>MapStore</code> (but it could embed any structs that implement the Store interface),
now we have a new struct that also implements the Store interface, but has a
different behavior. It will override two methods, <code>GetUser</code> and <code>DeleteUser</code>, and
<code>CountUsers</code> is going to be handled directly by the embedded store. The <code>GetUser</code>
will try to get the data from the cache, and if it&rsquo;s unable to, it will get the data from the
underlaying store and store that in the cache. And for <code>DeleteUser</code> we remove
the entry from the cache if it exists.</p>
<p>My <code>MapStore</code> doesn&rsquo;t know anything about the <code>CacheLayer</code>, and the <code>CacheLayer</code> only
knows that it have an underlying <code>Store</code>, but doesn&rsquo;t know anything about it except
the interface.</p>
<p>Now that we have these layers that intercept things passing through the
store we can do things like instrumentation, for example building a layer that
counts the number of calls per method:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#555">...</span>
<span style="color:#069;font-weight:bold">type</span> CounterLayer <span style="color:#069;font-weight:bold">struct</span> {
	Store
	counterGetUser    <span style="color:#078;font-weight:bold">int</span>
	counterDeleteUser <span style="color:#078;font-weight:bold">int</span>
	counterCountUsers <span style="color:#078;font-weight:bold">int</span>
}

<span style="color:#069;font-weight:bold">func</span> <span style="color:#c0f">NewCounterLayer</span>(substore Store) <span style="color:#555">*</span>CounterLayer {
	<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">&amp;</span>CounterLayer{
		Store: substore,
	}
}

<span style="color:#069;font-weight:bold">func</span> (s <span style="color:#555">*</span>CounterLayer) <span style="color:#c0f">GetUser</span>(username <span style="color:#078;font-weight:bold">string</span>) (<span style="color:#555">*</span>User, <span style="color:#078;font-weight:bold">error</span>) {
	s.counterGetUser<span style="color:#555">++</span>
	fmt.<span style="color:#c0f">Printf</span>(<span style="color:#c30">&#34;GetUser calls: %d.\n&#34;</span>, s.counterGetUser)
	<span style="color:#069;font-weight:bold">return</span> s.Store.<span style="color:#c0f">GetUser</span>(username)
}

<span style="color:#069;font-weight:bold">func</span> (s <span style="color:#555">*</span>CounterLayer) <span style="color:#c0f">DeleteUser</span>(username <span style="color:#078;font-weight:bold">string</span>) <span style="color:#078;font-weight:bold">error</span> {
	s.counterDeleteUser<span style="color:#555">++</span>
	fmt.<span style="color:#c0f">Printf</span>(<span style="color:#c30">&#34;DeleteUser calls: %d.\n&#34;</span>, s.counterDeleteUser)
	<span style="color:#069;font-weight:bold">return</span> s.Store.<span style="color:#c0f">DeleteUser</span>(username)
}

<span style="color:#069;font-weight:bold">func</span> (s <span style="color:#555">*</span>CounterLayer) <span style="color:#c0f">CountUsers</span>() <span style="color:#078;font-weight:bold">int</span> {
	s.counterCountUsers<span style="color:#555">++</span>
	fmt.<span style="color:#c0f">Printf</span>(<span style="color:#c30">&#34;CountUsers calls: %d.\n&#34;</span>, s.counterCountUsers)
	<span style="color:#069;font-weight:bold">return</span> s.Store.<span style="color:#c0f">CountUsers</span>()
}
<span style="color:#555">...</span>
</code></pre></div><p>This layers intercepts all the calls made to the store and prints the number of
calls so far.</p>
<p>Another more interesting layer would be a <code>TimerLayer</code>.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#555">...</span>
<span style="color:#069;font-weight:bold">type</span> TimerLayer <span style="color:#069;font-weight:bold">struct</span> {
	Store
}

<span style="color:#069;font-weight:bold">func</span> <span style="color:#c0f">NewTimerLayer</span>(substore Store) <span style="color:#555">*</span>TimerLayer {
	<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">&amp;</span>TimerLayer{
		Store: substore,
	}
}

<span style="color:#069;font-weight:bold">func</span> (s <span style="color:#555">*</span>TimerLayer) <span style="color:#c0f">GetUser</span>(username <span style="color:#078;font-weight:bold">string</span>) (<span style="color:#555">*</span>User, <span style="color:#078;font-weight:bold">error</span>) {
	start <span style="color:#555">:=</span> time.<span style="color:#c0f">Now</span>()
	user, err <span style="color:#555">:=</span> s.Store.<span style="color:#c0f">GetUser</span>(username)
	elapsed <span style="color:#555">:=</span> <span style="color:#366">float64</span>(time.<span style="color:#c0f">Since</span>(start)) <span style="color:#555">/</span> <span style="color:#366">float64</span>(time.Second)
	fmt.<span style="color:#c0f">Printf</span>(<span style="color:#c30">&#34;GetUser time %f secons.\n&#34;</span>, elapsed)
	<span style="color:#069;font-weight:bold">return</span> user, err
}

<span style="color:#069;font-weight:bold">func</span> (s <span style="color:#555">*</span>TimerLayer) <span style="color:#c0f">DeleteUser</span>(username <span style="color:#078;font-weight:bold">string</span>) <span style="color:#078;font-weight:bold">error</span> {
	start <span style="color:#555">:=</span> time.<span style="color:#c0f">Now</span>()
	err <span style="color:#555">:=</span> s.Store.<span style="color:#c0f">DeleteUser</span>(username)
	elapsed <span style="color:#555">:=</span> <span style="color:#366">float64</span>(time.<span style="color:#c0f">Since</span>(start)) <span style="color:#555">/</span> <span style="color:#366">float64</span>(time.Second)
	fmt.<span style="color:#c0f">Printf</span>(<span style="color:#c30">&#34;DeleteUser time %f secons.\n&#34;</span>, elapsed)
	<span style="color:#069;font-weight:bold">return</span> err
}

<span style="color:#069;font-weight:bold">func</span> (s <span style="color:#555">*</span>TimerLayer) <span style="color:#c0f">CountUsers</span>() <span style="color:#078;font-weight:bold">int</span> {
	start <span style="color:#555">:=</span> time.<span style="color:#c0f">Now</span>()
	count <span style="color:#555">:=</span> s.Store.<span style="color:#c0f">CountUsers</span>()
	elapsed <span style="color:#555">:=</span> <span style="color:#366">float64</span>(time.<span style="color:#c0f">Since</span>(start)) <span style="color:#555">/</span> <span style="color:#366">float64</span>(time.Second)
	fmt.<span style="color:#c0f">Printf</span>(<span style="color:#c30">&#34;CountUsers time %f secons.\n&#34;</span>, elapsed)
	<span style="color:#069;font-weight:bold">return</span> count
}
<span style="color:#555">...</span>
</code></pre></div><p>This allows us to know how much time is invested in each call. Our <code>TimerLayer</code>
implementation is pretty similar to this one, but sends this data to
Prometheous instead of printing it.</p>
<p>This code is super repetitive, and in Mattermost we have a lot of method in our
store, so we didn&rsquo;t write it by hand; we used generators to build the
<code>TimerLayer</code> and the <code>OpenTracingLayer</code>.</p>
<p>Using this kind of generator you can build all kinds of transparent layers that add extra behavior
like a <code>KafkaLayer</code> to send everything that happens to a kafka, a <code>LoggerLayer</code>
to log everything, a <code>RandomDelayLayer</code> to test weird behaviors on inconsistent
response times, or any other &ldquo;middleware&rdquo; that you can think about.</p>
<p>After everything is implemented we can glue it together by embedding the <code>MapStore</code>
inside the layers, initializing with some data, and testing how it works:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#555">...</span>
<span style="color:#069;font-weight:bold">func</span> <span style="color:#c0f">main</span>() {
	mapStore <span style="color:#555">:=</span> <span style="color:#c0f">NewMapStore</span>()
	mapStore.db[<span style="color:#c30">&#34;test1&#34;</span>] = <span style="color:#555">&amp;</span>User{Username: <span style="color:#c30">&#34;test1&#34;</span>, FullName: <span style="color:#c30">&#34;Test User 1&#34;</span>}
	mapStore.db[<span style="color:#c30">&#34;test2&#34;</span>] = <span style="color:#555">&amp;</span>User{Username: <span style="color:#c30">&#34;test2&#34;</span>, FullName: <span style="color:#c30">&#34;Test User 2&#34;</span>}
	AppStore <span style="color:#555">:=</span>
		<span style="color:#c0f">NewTimerLayer</span>(
			<span style="color:#c0f">NewCounterLayer</span>(
				<span style="color:#c0f">NewCacheLayer</span>(
					mapStore,
				),
			),
		)

	<span style="color:#09f;font-style:italic">// Getting the user 1 from the map store (showing the time)
</span><span style="color:#09f;font-style:italic"></span>	AppStore.<span style="color:#c0f">GetUser</span>(<span style="color:#c30">&#34;test1&#34;</span>)
	<span style="color:#09f;font-style:italic">// Getting the user 2 from the map store (showing the time)
</span><span style="color:#09f;font-style:italic"></span>	AppStore.<span style="color:#c0f">GetUser</span>(<span style="color:#c30">&#34;test2&#34;</span>)
	<span style="color:#09f;font-style:italic">// Getting the user 1 from the cache store (showing the time)
</span><span style="color:#09f;font-style:italic"></span>	AppStore.<span style="color:#c0f">GetUser</span>(<span style="color:#c30">&#34;test1&#34;</span>)

	<span style="color:#09f;font-style:italic">// Delete user 1 from the map store (showing the time)
</span><span style="color:#09f;font-style:italic"></span>	AppStore.<span style="color:#c0f">DeleteUser</span>(<span style="color:#c30">&#34;test1&#34;</span>)

	<span style="color:#09f;font-style:italic">// Counting users
</span><span style="color:#09f;font-style:italic"></span>	AppStore.<span style="color:#c0f">CountUsers</span>()
}
</code></pre></div><p>If you execute the whole program you&rsquo;ll get a similar output to this:</p>
<pre><code>GetUser calls: 1.
GetUser time 0.100314 secons.
GetUser calls: 2.
GetUser time 0.100189 secons.
GetUser calls: 3.
GetUser time 0.000041 secons.
DeleteUser calls: 1.
DeleteUser time 0.200158 secons.
CountUsers calls: 1.
CountUsers time 0.150186 secons.
</code></pre><p>You can see the first two calls to <code>GetUser</code> are from the <code>MapStore</code> (because we have
the <code>time.Sleep</code> there), the third one is faster because you are using the
<code>CacheLayer</code>, and we can see all this thanks to the instrumentation layers that
we built.</p>
<p>This approach is not perfect, and does have some flaws. The main one is that the
struct embedding doesn&rsquo;t behave as one coming from object oriented languages
would expect from inheritance - because is not inheritance. When you call a
method in a struct that embeds another struct, and the method doesn&rsquo;t exist in
the parent struct, the embedded struct method is called, and at that point, you
are in the embedded struct without any knowledge of the parent struct. So, if
you call any other method of the struct, it will not be overridden and
this can be error prone sometimes.</p>
<p>Another problem with this approach is related to how the layers work. You are
wrapping entire methods, so it&rsquo;s all or nothing. You can&rsquo;t override part of the
method, or reuse only certain parts of the underlying code easily and that can
generate a ton of duplicated code depending on what you want to do.</p>
<p>We implemented this architecture change some months ago, and so far for us it&rsquo;s
been a very good way to add our instrumentation and cache without mixing
responsibilities in our source code. And we believe that going forward we can add special layers to
generate performance improvements relaying in other services, like key value
stores, or graph databases and we&rsquo;re looking into that.</p>


                    <hr>
                    
                    Written by
                    
                    Jesús Espino
-
<a href="https://community.mattermost.com/core/messages/@jesus.espino" target="_blank">
    @jesus.espino
</a>
on
<a href="https://community.mattermost.com/signup_user_complete/?id=f1924a8db44ff3bb41c96424cdc20676" target="_blank">
    community.mattermost.com
</a>
and
<a href="https://github.com/jespino" target="_blank">
    @jespino
</a>
on GitHub

                    
                    
                    <br />
                    <br />
                    Join us on <a href="https://community.mattermost.com/signup_user_complete/?id=f1924a8db44ff3bb41c96424cdc20676"
                        target="_blank">community.mattermost.com</a>!
                </div>
            </div>

            
            <div class="col-md-3 doc-content tags-sidebar">
                <div class="well well-sm">
                    
                    


                    <h6>Other Posts</h6>
                    <ul class="list-unstyled">
                        
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/pritunl/">From OpenVPN to Pritunl VPN: The transition</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/open-tracing/">OpenTracing for Go Projects</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/hands-on-iouring-go/">Getting Hands-on with io_uring using Go</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/advanced-git-tbilisi-free-university/">Advanced Git with the Free University of Tbilisi</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/all-about-emojis/">All About Emojis</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/maintaining-consistency-in-codebases-with-go-vet/">Maintaining Consistency in Codebases with Go vet</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/instrumenting-go-code-via-ast-2/">Instrumenting Go code via AST, Part 2</a></li>
                        
                        
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/incorporating-golangci-lint/">Incorporating GolangCI-Lint at Mattermost</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/on-hermes-and-mattermost/">On Hermes and Mattermost</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/onboarding-with-mattermost/">Onboarding with Mattermost</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/kubecon-na-2019/">KubeCon NA 2019</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/cloud-monitoring/">Monitoring a Multi-Cluster Environment Using Prometheus Federation and Grafana</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/localizing-matterpoll/">Localizing Matterpoll</a></li>
                        
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>

</html>