<!DOCTYPE html>





<html>

<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title> LDAP Nested Groups: Modelling and Representation in Code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">   
<meta http-equiv="content-language" content="en-us" />



<link rel="canonical" href="../../blog/ldap-nested-groups-modelling-and-representation-in-code/">


<link rel="shortcut icon" type="image/png" href="../../img/favicon-32x32.png" />

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600" rel="stylesheet">


<link rel="stylesheet" href="../../css/bootstrap.min.css">
<link rel="stylesheet" href="../../css/tabs.css">
<link rel="stylesheet" href="../../css/bar.css">
<link rel="stylesheet" href="../../css/styles.css">
<link rel="stylesheet" href="../../css/code.css">
<link rel="stylesheet" href="../../css/note.css">


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="../../js/tabs.js"></script>
<script src="../../js/main.js"></script>
<script async defer src="https://buttons.github.io/buttons.js"></script>
<script async src="//cdn.bizible.com/scripts/bizible.js"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-64458817-2"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-64458817-2');
</script>


<script type="text/javascript">
    (function() {
    var didInit = false;
    function initMunchkin() {
    if(didInit === false) {
    didInit = true;
    Munchkin.init('161-FBE-733');
    }
    }
    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = '//munchkin.marketo.net/munchkin.js';
    s.onreadystatechange = function() {
    if (this.readyState == 'complete' || this.readyState == 'loaded') {
    initMunchkin();
    }
    };
    s.onload = initMunchkin;
    document.getElementsByTagName('head')[0].appendChild(s);
    })();
</script>


<script type="text/javascript" charset="utf-8">
    var _eiq = _eiq || [];
    var _engagio_settings = {
      accountId: "cb6a404b72e9141b70d1f82abc04db92b4e56238"
    };
    (function() {
      var ei = document.createElement('script'); ei.type = 'text/javascript'; ei.async = true;
      ei.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'web-analytics.engagio.com/js/ei.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ei, s);
    })();
  </script>

</head>

<body class="blog-single">
    <header>
    <a href="../../"><img src="../../img/logo.svg" alt="Mattermost Logo" width="212px"></a>
    <div class="header__menu-toggle">
        <i class="fa fa-bars"></i>
    </div>
    <ul class="header__links--right">
        <li><a href="../../">Home</a></li>
        
            
            
            
                
                    <li><a href="../../contribute/getting-started">Contribute</a></li>
                
            
        
            
            
            
                
                    <li><a href="../../integrate/getting-started">Integrate</a></li>
                
            
        
            
            
            
                
                    <li><a href="../../extend/getting-started">Extend</a></li>
                
            
        
            
            
            
                
                    <li class="active"><a href="../../blog">Blog</a></li>
                
            
        
            
            
            
                
                    <li><a href="https://docs.mattermost.com/">Admin Docs</a></li>
                
            
        
    </ul>
</header>




    <div class="container">
        <div class="row">
            <div class="col-md-9 doc-content">
                <div class="well well-sm">
                    <div class="blog-item__header">
                        <div class="blog-item__title">LDAP Nested Groups: Modelling and Representation in Code<br> <small></small></div>
                        <div class="blog-item__info">
                            June 5, 2019
                            <small class="blog-item__count">705 words</small>
                        </div>
                    </div>
                    <hr>
                    <h2 id="ldap-group-sync-in-mattermost">LDAP Group Sync in Mattermost&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#ldap-group-sync-in-mattermost"></i></a> </h2>
<p>In <a href="https://mattermost.com">Mattermost</a> v5.8 we deployed <a href="https://mattermost.com/pl/default-ldap-group-sync">LDAP group sync feature</a> to enable Enterprise Edition customers to create and synchronize groups in Mattermost matching their LDAP groups. The goal was to ease onboarding by automatically adding group members to configured teams and channels.</p>
<p>With the upcoming Mattermost v5.12 we&rsquo;re adding the ability to create teams and channels that are only accessible to those synced groups. This post describes what LDAP &ldquo;nested groups&rdquo; are and how we ended up modelling and representing them in code.</p>
<h2 id="defining-nested-groups">Defining Nested Groups&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#defining-nested-groups"></i></a> </h2>
<p>The two main types of groups in LDAP are <code>groupOfNames</code> and <code>groupOfUniqueNames</code>. At minimum they have a <code>cn</code> (common name) attribute and can have membership attributes <code>member</code> or <code>uniqueMember</code>, respectively.</p>
<p>As an example, the below LDIF creates two groups: <code>developers</code> and <code>senior-developers</code>.</p>
<pre><code class="language-ldif" data-lang="ldif">dn: cn=developers,ou=groups,dc=www,dc=test,dc=com
changetype: add
objectclass: groupOfNames
member: uid=miranda,ou=users,dc=www,dc=test,dc=com
member: cn=senior-developers,ou=groups,dc=www,dc=test,dc=com

dn: cn=senior-developers,ou=groups,dc=www,dc=test,dc=com
changetype: add
objectclass: groupOfNames
member: uid=suzanne,ou=users,dc=www,dc=test,dc=com
</code></pre><p>The <code>developers</code> group has two members: a person <code>miranda</code> and another group <code>senior-developers</code>. The <code>senior-developers</code> group has a single member: a person <code>suzanne</code>.</p>
<p>When a group has another group as a member we call it a &ldquo;nested group&rdquo;.</p>
<h2 id="objectives">Objectives&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#objectives"></i></a> </h2>
<p>There are two main query operations one wants to perform when dealing with nested groups.</p>
<ol>
<li>List all of the members of group X.</li>
<li>List all of the groups that person Y belongs to.</li>
</ol>
<p>For our example, these propositions are all true:</p>
<ul>
<li><code>developers</code> has members <code>[miranda, suzanne]</code></li>
<li><code>senior-developers</code> has members <code>[suzanne]</code></li>
<li><code>suzanne</code> is a member of groups <code>[developers, senior-developers]</code></li>
<li><code>miranda</code> is a member of groups <code>[developers]</code></li>
</ul>
<h2 id="native-solution">Native Solution&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#native-solution"></i></a> </h2>
<p>There&rsquo;s an &ldquo;extensible match operator&rdquo; called <code>LDAP_MATCHING_RULE_IN_CHAIN</code> that, if installed, traverses nested groups. It&rsquo;s used by adding the string <code>:1.2.840.113556.1.4.1941:</code> to your query filter.</p>
<p>For example, this filter retrieves all of the recursive members of <code>developers</code>:</p>
<pre><code>(&amp;
    (objectClass=person)
    (memberOf:1.2.840.113556.1.4.1941:=cn=developers,ou=groups,dc=www,dc=test,dc=com)
)
</code></pre><p>And this filter retrieves all of the recursive groups that <code>suzanne</code> belongs to:</p>
<pre><code>(member:1.2.840.113556.1.4.1941:=uid=suzanne,ou=users,dc=www,dc=test,dc=com)
</code></pre><p>However, not all LDAP implementations natively support <code>LDAP_MATCHING_RULE_IN_CHAIN</code>, so when we set out to support LDAP nested groups in Mattermost I realized we would need to do the group traversal in our application code.</p>
<h2 id="modelling-the-problem">Modelling the Problem&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#modelling-the-problem"></i></a> </h2>
<p>We can represent our example arrangement with a directed graph (aka digraph) as seen in <em>figure 1</em>.</p>
<p><img src="../../img/nested-group.png" alt="nested group">
<em>figure 1</em></p>
<p>The digraph makes the structure easy to reason about and, moreover, because cycles are possible in LDAP nested groups — group A can have group B as a member which in turn has group A as a member — the digraph is critical to avoiding needless code complexity and errors. Here&rsquo;s how it works:</p>
<h3 id="from-a-groups-perspective">From a Group&rsquo;s Perspective&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#from-a-groups-perspective"></i></a> </h3>
<p>To list all of the members of, say, the <code>developers</code> group, simply traverse the graph in <em>figure 1</em> starting at <code>developers</code>. All reachable vertices (that are people) are the members of the <code>developers</code> group.</p>
<h3 id="from-a-persons-perspective">From a Person&rsquo;s Perspective&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#from-a-persons-perspective"></i></a> </h3>
<p>To list all of the groups that, say, <code>suzanne</code> belongs to, reverse all of the edges in the graph (aka transpose it) — as seen in <em>figure 2</em> — and traverse the graph starting at <code>suzanne</code>. All of the reachable vertices (that are groups) are the groups that <code>suzanne</code> belongs to.</p>
<p><img src="../../img/nested-group-transposed.png" alt="nested group transposed">
<em>figure 2</em></p>
<p>The same data model and traversal logic can be reused to achieve both of our main objectives.</p>
<h2 id="representation-in-code">Representation in Code&nbsp;<a class="hanchor fa fa-link" ariaLabel="Anchor" href="#representation-in-code"></i></a> </h2>
<p>In Mattermost I represent the digraph as an adjacency list. In Golang our <em>figure 1</em> graph looks like this:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">adjacencyList <span style="color:#555">:=</span> <span style="color:#069;font-weight:bold">map</span>[<span style="color:#078;font-weight:bold">string</span>][]<span style="color:#078;font-weight:bold">string</span>{
    <span style="color:#c30">&#34;group/developers&#34;</span>:        []<span style="color:#078;font-weight:bold">string</span>{<span style="color:#c30">&#34;person/miranda&#34;</span>, <span style="color:#c30">&#34;group/senior-developers&#34;</span>},
    <span style="color:#c30">&#34;group/senior-developers&#34;</span>: []<span style="color:#078;font-weight:bold">string</span>{<span style="color:#c30">&#34;person/suzanne&#34;</span>},
    <span style="color:#09f;font-style:italic">//&#34;person/miranda&#34;:          []string{},
</span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">//&#34;person/suzanne&#34;:          []string{},
</span><span style="color:#09f;font-style:italic"></span>}
</code></pre></div><p>Normally an adjacency list representing a graph would include all vertices as keys in the array or map. However, in our LDAP case people will never have groups or other people nested under them, so I was able to remove those keys without losing any relevant data.</p>
<p>Our reversed graph from <em>figure 2</em> is represented as an adjacency list like this:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">transposedAdjacencyList <span style="color:#555">:=</span> <span style="color:#069;font-weight:bold">map</span>[<span style="color:#078;font-weight:bold">string</span>][]<span style="color:#078;font-weight:bold">string</span>{
    <span style="color:#c30">&#34;person/miranda&#34;</span>:          []<span style="color:#078;font-weight:bold">string</span>{<span style="color:#c30">&#34;group/developers&#34;</span>},
    <span style="color:#c30">&#34;group/senior-developers&#34;</span>: []<span style="color:#078;font-weight:bold">string</span>{<span style="color:#c30">&#34;group/developers&#34;</span>},
    <span style="color:#c30">&#34;person/suzanne&#34;</span>:          []<span style="color:#078;font-weight:bold">string</span>{<span style="color:#c30">&#34;group/senior-developers&#34;</span>},
    <span style="color:#c30">&#34;group/developers&#34;</span>:        []<span style="color:#078;font-weight:bold">string</span>{},
}
</code></pre></div><p>One can input the adjacency list into a breadth-first (or depth-first) search — avoiding cycles — to get the reachable vertices. It performs well at scale and is easy to serialize and debug.</p>
<p>That pretty much summarizes the interesting parts of modelling and representing LDAP nested groups. If you have any questions feel free to reach out. Thanks for reading!</p>
<p>[cross-posted from <a href="http://martin.upspin.org/2019/06/03/ldap-nested-groups-modelling-and-representation-in-code.html">Martin&rsquo;s personal blog</a>]</p>


                    <hr>
                    
                    Written by
                    
                    Martin Kraft
-
<a href="https://community.mattermost.com/core/messages/@martin.kraft" target="_blank">
    @martin.kraft
</a>
on
<a href="https://community.mattermost.com/signup_user_complete/?id=f1924a8db44ff3bb41c96424cdc20676" target="_blank">
    community.mattermost.com
</a>
and
<a href="https://github.com/mkraft" target="_blank">
    @mkraft
</a>
on GitHub

                    
                    
                    <br />
                    <br />
                    Join us on <a href="https://community.mattermost.com/signup_user_complete/?id=f1924a8db44ff3bb41c96424cdc20676"
                        target="_blank">community.mattermost.com</a>!
                </div>
            </div>

            
            <div class="col-md-3 doc-content tags-sidebar">
                <div class="well well-sm">
                    
                    


                    <h6>Other Posts</h6>
                    <ul class="list-unstyled">
                        
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/pritunl/">From OpenVPN to Pritunl VPN: The transition</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/open-tracing/">OpenTracing for Go Projects</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/hands-on-iouring-go/">Getting Hands-on with io_uring using Go</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/advanced-git-tbilisi-free-university/">Advanced Git with the Free University of Tbilisi</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/all-about-emojis/">All About Emojis</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/maintaining-consistency-in-codebases-with-go-vet/">Maintaining Consistency in Codebases with Go vet</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/instrumenting-go-code-via-ast-2/">Instrumenting Go code via AST, Part 2</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/layered-store-and-struct-embedding/">Layered Store and Struct Embedding in Go</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/incorporating-golangci-lint/">Incorporating GolangCI-Lint at Mattermost</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/on-hermes-and-mattermost/">On Hermes and Mattermost</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/onboarding-with-mattermost/">Onboarding with Mattermost</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/kubecon-na-2019/">KubeCon NA 2019</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/cloud-monitoring/">Monitoring a Multi-Cluster Environment Using Prometheus Federation and Grafana</a></li>
                        
                        
                        
                        <li class="blog-item__sidebar">- <a href="../../blog/localizing-matterpoll/">Localizing Matterpoll</a></li>
                        
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>

</html>